"use strict";(()=>{var e={};e.id=702,e.ids=[702],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},6162:e=>{e.exports=require("worker_threads")},71568:e=>{e.exports=require("zlib")},87561:e=>{e.exports=require("node:fs")},84492:e=>{e.exports=require("node:stream")},72477:e=>{e.exports=require("node:stream/web")},15628:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>g,patchFetch:()=>E,requestAsyncStorage:()=>h,routeModule:()=>A,serverHooks:()=>y,staticGenerationAsyncStorage:()=>N});var s={};t.r(s),t.d(s,{OPTIONS:()=>d,POST:()=>c,runtime:()=>l});var n=t(49303),o=t(88716),a=t(60670),i=t(87070),p=t(16636),u=t.n(p);u().config({path:".env.local"}),process.env.AZURE_OPENAI_ENDPOINT||(u().config({path:".env"}),u().config({path:"../.env.local"}),u().config({path:"../.env"}),u().config({path:"../../.env.local"}),u().config({path:"../../.env"}));let l="nodejs";function m(e){return e.headers.set("Access-Control-Allow-Origin","*"),e.headers.set("Access-Control-Allow-Headers","Content-Type"),e.headers.set("Access-Control-Allow-Methods","POST, OPTIONS"),e}async function c(e){try{let r,s;let{department:n,risks:o,role:a,userName:p,incidents:u}=await e.json();if(!Array.isArray(o)||0===o.length)return m(i.NextResponse.json({error:"No risks provided"},{status:400}));let l=process.env.AZURE_OPENAI_ENDPOINT||process.env.NEXT_PUBLIC_AZURE_OPENAI_ENDPOINT,c=process.env.AZURE_OPENAI_API_KEY||process.env.NEXT_PUBLIC_AZURE_OPENAI_API_KEY,d=process.env.AZURE_OPENAI_API_VERSION||process.env.NEXT_PUBLIC_AZURE_OPENAI_API_VERSION,A=process.env.AZURE_OPENAI_COMPLETION_DEPLOYMENT||process.env.AZURE_OPENAI_CHAT_DEPLOYMENT||process.env.NEXT_PUBLIC_AZURE_OPENAI_COMPLETION_DEPLOYMENT||process.env.NEXT_PUBLIC_AZURE_OPENAI_CHAT_DEPLOYMENT;if(!l||!c||!d)return m(i.NextResponse.json({error:"Missing Azure OpenAI environment configuration"},{status:500}));let h=[(()=>{let e=n||"All",r=(a||"").toLowerCase();return"user"===r?`Scope: Summarize ONLY the user's visible risks in department ${e}. User: ${p||"N/A"}.`:"manager"===r?`Scope: Summarize ONLY risks for department ${e}.`:"admin"===r?"All"===e?"Scope: Summarize organization-wide risks across all departments.":`Scope: Summarize ONLY risks for department ${e}.`:`Scope: Summarize risks for department ${e}.`})(),"IMPORTANT: Use ONLY the lists provided below.","Formatting rules (strict):","- Start with the header: Risk Summary",'- Then write bullets for risks using "- " (no numbers, no bold).',"- One sentence per bullet; each bullet on a separate line.","- Each risk bullet must include: RiskNo/Name, Impact, Likelihood, and a short recommended action.",u&&Array.isArray(u)&&u.length?"- After risk bullets, add an empty line and the header: Incident Summary":"",u&&Array.isArray(u)&&u.length?'- Under Incident Summary, group by risk: first a bullet "- <RiskNo or Name>:", followed by sub-bullets "- " for each incident (summary, YYYY-MM, status).':"","- Do not include extra symbols or numbering; use plain hyphens only.","- Keep language simple and clear.","- Prioritize Severe and Significant risks first."].filter(Boolean).join("\n"),N=o.map(e=>`- riskNo=${e.riskNo||""}; name=${e.name||""}; impact=${e.impact||""}; likelihood=${e.likelihood||""}; status=${e.status||""}; dept=${e.department||""}`).join("\n"),y=(Array.isArray(u)?u:[]).map(e=>`- riskNo=${e.RiskNo||e.riskNo||""}; summary=${e.Summary||e.summary||""}; occurred=${(e.OccurredAtUtc||e.occurredAt||"").toString().slice(0,7)}; status=${e.CurrentStatusText||e.currentStatusText||""}`).join("\n"),g={messages:[{role:"system",content:"You are a professional risk management assistant. Always return concise bullet points using plain hyphens (- ). One sentence per bullet. No numbering, no bold, no tables."},{role:"user",content:`${h}

Risks:
${N}${u&&Array.isArray(u)&&u.length?`

Incidents:
${y}`:""}`}],temperature:.3,max_tokens:800};A&&(g.model=A);let E=String(l||"").trim().replace(/^http:\/\//i,"https://"),O=/\/openai\/deployments\//i.test(E);if(!O&&!A)return m(i.NextResponse.json({error:"Missing deployment name: set AZURE_OPENAI_COMPLETION_DEPLOYMENT"},{status:500}));try{let{AzureOpenAI:e}=await Promise.all([t.e(181),t.e(854)]).then(t.bind(t,71854)),r=O?E.split("/openai/")[0]:E.replace(/\/$/,""),s=new e({endpoint:r,apiKey:c,deployment:A,apiVersion:d}),n=await s.chat.completions.create({messages:g.messages,max_tokens:g.max_tokens,temperature:g.temperature,model:A}),o=n?.choices?.[0]?.message?.content||"";return m(i.NextResponse.json({summary:o}))}catch(e){try{if(/\.openai\.azure\.com\/?$/i.test(E)){let{AzureOpenAI:e}=await Promise.all([t.e(181),t.e(854)]).then(t.bind(t,71854)),r=E.replace(/\.openai\.azure\.com\/?$/i,".cognitiveservices.azure.com/").replace(/\/$/,""),s=new e({endpoint:r,apiKey:c,deployment:A,apiVersion:d}),n=await s.chat.completions.create({messages:g.messages,max_tokens:g.max_tokens,temperature:g.temperature,model:A}),o=n?.choices?.[0]?.message?.content||"";return m(i.NextResponse.json({summary:o}))}}catch{}}if(O)r=/[?&]api-version=/.test(E)?E:`${E}${E.includes("?")?"&":"?"}api-version=${encodeURIComponent(d)}`;else{let e=E.replace(/\/$/,"");r=`${e}/openai/deployments/${A}/chat/completions?api-version=${encodeURIComponent(d)}`}let _=new AbortController,P=setTimeout(()=>_.abort(),2e4);try{s=await fetch(r,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json","api-key":c},body:JSON.stringify(g),signal:_.signal})}catch(e){return clearTimeout(P),m(i.NextResponse.json({error:"Upstream Azure OpenAI fetch failed",message:String(e?.message||e),hint:"Verify endpoint format (https://<resource>.openai.azure.com), deployment name, and API version. Ensure outbound internet and DNS are available from the server.",details:{url:r,endpoint:E,deployment:A,apiVersion:d,aborted:e?.name==="AbortError"||void 0}},{status:502}))}finally{clearTimeout(P)}if(!s.ok){let e=await s.text();return m(i.NextResponse.json({error:`Azure OpenAI error: ${s.status} ${e}`},{status:502}))}let x=await s.json(),I=x?.choices?.[0]?.message?.content||"";return m(i.NextResponse.json({summary:I}))}catch(e){return m(i.NextResponse.json({error:String(e?.message||e)},{status:500}))}}async function d(){return m(new i.NextResponse(null,{status:204}))}let A=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/ai/summary/route",pathname:"/api/ai/summary",filename:"route",bundlePath:"app/api/ai/summary/route"},resolvedPagePath:"C:\\Users\\127547.INDIA\\Documents\\enterprise-risk-management-dashboard\\server-next\\app\\api\\ai\\summary\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:h,staticGenerationAsyncStorage:N,serverHooks:y}=A,g="/api/ai/summary/route";function E(){return(0,a.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:N})}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[542],()=>t(15628));module.exports=s})();