"use strict";(()=>{var e={};e.id=873,e.ids=[873],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},9714:e=>{e.exports=require("constants")},84770:e=>{e.exports=require("crypto")},18139:e=>{e.exports=require("dgram")},80665:e=>{e.exports=require("dns")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},20629:e=>{e.exports=require("fs/promises")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},74026:e=>{e.exports=require("string_decoder")},95346:e=>{e.exports=require("timers")},82452:e=>{e.exports=require("tls")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},6005:e=>{e.exports=require("node:crypto")},15673:e=>{e.exports=require("node:events")},88849:e=>{e.exports=require("node:http")},22286:e=>{e.exports=require("node:https")},70612:e=>{e.exports=require("node:os")},97742:e=>{e.exports=require("node:process")},84492:e=>{e.exports=require("node:stream")},41041:e=>{e.exports=require("node:url")},47261:e=>{e.exports=require("node:util")},65628:e=>{e.exports=require("node:zlib")},20178:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>N,patchFetch:()=>E,requestAsyncStorage:()=>c,routeModule:()=>m,serverHooks:()=>D,staticGenerationAsyncStorage:()=>I});var s={};r.r(s),r.d(s,{OPTIONS:()=>l,POST:()=>u,runtime:()=>d});var n=r(49303),o=r(88716),a=r(60670),i=r(87070),p=r(9487);let d="nodejs";async function u(e){try{let t=await e.json(),r=String(t.name??"").trim(),s=String(t.role??"").trim(),n=(t.department??t.departmentName??"").toString().trim();if(!r||"user"!==s&&"manager"!==s&&"admin"!==s)return i.NextResponse.json({error:"Invalid name or role"},{status:400});"admin"===s&&(n="");let o=await (0,p.M)(),a=o.request(),d=null;if("admin"!==s){if(n){let e=await a.input("DepName",n).query(`
          SELECT DepartmentId FROM dbo.Departments WHERE Name = @DepName
        `);d=e.recordset.length>0?e.recordset[0].DepartmentId:(await o.request().input("DepName",n).query(`
            DECLARE @newId UNIQUEIDENTIFIER = NEWID();
            INSERT INTO dbo.Departments (DepartmentId, Name) VALUES (@newId, @DepName);
            SELECT @newId AS DepartmentId;
          `)).recordset[0].DepartmentId}else{let e=await o.request().query(`
          SELECT TOP 1 DepartmentId FROM dbo.Departments WHERE Name = N'Engineering'
        `);if(e.recordset.length>0)d=e.recordset[0].DepartmentId;else{let e=await o.request().query(`
            SELECT TOP 1 DepartmentId FROM dbo.Departments ORDER BY Name ASC
          `);d=e.recordset.length>0?e.recordset[0].DepartmentId:(await o.request().input("DepName","Engineering").query(`
              DECLARE @newId UNIQUEIDENTIFIER = NEWID();
              INSERT INTO dbo.Departments (DepartmentId, Name) VALUES (@newId, @DepName);
              SELECT @newId AS DepartmentId;
            `)).recordset[0].DepartmentId}}}let u=o.request().input("Name",r).input("Role",s).input("DepartmentId",d),l=await u.query(`
      SELECT TOP 1 u.UserId, u.Name, u.Role, u.DepartmentId, d.Name AS Department
      FROM dbo.Users u
      LEFT JOIN dbo.Departments d ON d.DepartmentId = u.DepartmentId
      WHERE u.Name = @Name AND u.Role = @Role
        AND ((@DepartmentId IS NULL AND u.DepartmentId IS NULL) OR (u.DepartmentId = @DepartmentId))
    `);if(l.recordset.length>0){let e=i.NextResponse.json({user:l.recordset[0]},{status:200});return e.headers.set("Access-Control-Allow-Origin","*"),e.headers.set("Access-Control-Allow-Headers","Content-Type"),e.headers.set("Access-Control-Allow-Methods","POST, OPTIONS"),e}let m=o.request().input("Name",r).input("Role",s).input("DepartmentId",d),c=await m.query(`
      DECLARE @newId UNIQUEIDENTIFIER = NEWID();
      INSERT INTO dbo.Users (UserId, Name, Role, DepartmentId)
      VALUES (@newId, @Name, @Role, @DepartmentId);
      SELECT u.UserId, u.Name, u.Role, u.DepartmentId, d.Name AS Department
      FROM dbo.Users u LEFT JOIN dbo.Departments d ON d.DepartmentId = u.DepartmentId
      WHERE u.UserId = @newId;
    `);{let e=i.NextResponse.json({user:c.recordset[0]},{status:201});return e.headers.set("Access-Control-Allow-Origin","*"),e.headers.set("Access-Control-Allow-Headers","Content-Type"),e.headers.set("Access-Control-Allow-Methods","POST, OPTIONS"),e}}catch(t){let e=i.NextResponse.json({error:"Login failed",detail:String(t?.message??t)},{status:500});return e.headers.set("Access-Control-Allow-Origin","*"),e.headers.set("Access-Control-Allow-Headers","Content-Type"),e.headers.set("Access-Control-Allow-Methods","POST, OPTIONS"),e}}async function l(){let e=new i.NextResponse(null,{status:204});return e.headers.set("Access-Control-Allow-Origin","*"),e.headers.set("Access-Control-Allow-Headers","Content-Type"),e.headers.set("Access-Control-Allow-Methods","POST, OPTIONS"),e}let m=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/auth/login/route",pathname:"/api/auth/login",filename:"route",bundlePath:"app/api/auth/login/route"},resolvedPagePath:"C:\\Users\\127547.INDIA\\Documents\\enterprise-risk-management-dashboard\\server-next\\app\\api\\auth\\login\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:c,staticGenerationAsyncStorage:I,serverHooks:D}=m,N="/api/auth/login/route";function E(){return(0,a.patchFetch)({serverHooks:D,staticGenerationAsyncStorage:I})}},9487:(e,t,r)=>{r.d(t,{M:()=>i});var s=r(33049),n=r.n(s),o=r(16636);r.n(o)().config({path:".env.local"});let a=null;async function i(){if(a&&a.connected)return a;a&&!a.connected&&await a.close();let e={server:process.env.DB_SERVER||"riskmanage.database.windows.net",database:process.env.DB_NAME||"riskmanagement",user:process.env.DB_USER||"riskmanagement",password:process.env.DB_PASSWORD||"RiskManage@123",port:Number(process.env.DB_PORT)||1433,options:{encrypt:!0,trustServerCertificate:!1},pool:{max:10,min:0,idleTimeoutMillis:3e4}};return a=await new(n()).ConnectionPool(e).connect()}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[542,181,49],()=>r(20178));module.exports=s})();